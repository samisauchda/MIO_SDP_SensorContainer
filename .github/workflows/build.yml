name: CI/CD Pipeline

on:
    push:
        branches:
            - develop
    pull_request:
        branches:
            - develop

jobs:
    lint:
        name: Code Quality Check
        runs-on: ubuntu-latest
        steps:
            -   name: Check out repository
                uses: actions/checkout@v4

            -   name: Set up Python
                uses: actions/setup-python@v5
                with:
                    python-version: '3.11'

            -   name: Install dependencies
                run: |
                    python -m pip install --upgrade pip
                    pip install ruff

            -   name: Run Ruff linting
                run: ruff check app/

    test:
        name: Run Tests
        runs-on: ubuntu-latest
        needs: lint
        steps:
            -   name: Check out repository
                uses: actions/checkout@v4

            -   name: Set up Python
                uses: actions/setup-python@v5
                with:
                    python-version: '3.11'

            -   name: Install dependencies
                run: |
                    python -m pip install --upgrade pip
                    pip install -r requirements.txt
                    pip install -r requirements-dev.txt

            -   name: Run unit tests
                run: pytest tests/test_unit.py -v --cov=app --cov-report=term

            -   name: Run integration tests
                run: pytest tests/test_integration.py -v

            -   name: Upload coverage reports
                uses: codecov/codecov-action@v4
                if: always()
                with:
                    file: ./coverage.xml
                    flags: unittests
                    name: codecov-umbrella
                    fail_ci_if_error: false

    build:
        name: Build Docker Images
        runs-on: ubuntu-latest
        needs: test
        steps:
            -   name: Set up QEMU
                uses: docker/setup-qemu-action@v3
                with:
                    platforms: arm64,amd64

            -   name: Check out repository
                uses: actions/checkout@v4

            -   name: Set up Docker Buildx
                uses: docker/setup-buildx-action@v3

            -   name: Build multi-platform container
                uses: docker/build-push-action@v5
                with:
                    context: .
                    platforms: linux/arm64,linux/amd64
                    push: false
                    tags: mio_sdp_container:latest
                    cache-from: type=gha
                    cache-to: type=gha,mode=max


    # security-scan:
    #     name: Security Vulnerability Scan
    #     runs-on: ubuntu-latest
    #     needs: build
    #     steps:
    #         -   name: Check out repository
    #             uses: actions/checkout@v4

    #         -   name: Download Docker image artifact
    #             uses: actions/download-artifact@v4
    #             with:
    #                 name: docker-image

    #         -   name: Load Docker image
    #             run: docker load -i mio_sdp_container.tar

    #         -   name: Run Trivy vulnerability scanner
    #             uses: aquasecurity/trivy-action@master
    #             with:
    #                 image-ref: 'mio_sdp_container:latest'
    #                 format: 'sarif'
    #                 output: 'trivy-results.sarif'
    #                 severity: 'CRITICAL,HIGH'

    #         -   name: Upload Trivy results to GitHub Security
    #             uses: github/codeql-action/upload-sarif@v3
    #             if: always()
    #             with:
    #                 sarif_file: 'trivy-results.sarif'

    #         -   name: Run Trivy vulnerability scanner (table output)
    #             uses: aquasecurity/trivy-action@master
    #             with:
    #                 image-ref: 'mio_sdp_container:latest'
    #                 format: 'table'
    #                 severity: 'CRITICAL,HIGH,MEDIUM'

    #         -   name: Scan Python dependencies with pip-audit
    #             run: |
    #                 python -m pip install --upgrade pip
    #                 pip install pip-audit
    #                 pip-audit -r requirements.txt || true

    dependency-scan:
        name: Dependency Vulnerability Scan
        runs-on: ubuntu-latest
        steps:
            -   name: Check out repository
                uses: actions/checkout@v4

            -   name: Set up Python
                uses: actions/setup-python@v5
                with:
                    python-version: '3.11'

            -   name: Install pip-audit
                run: |
                    python -m pip install --upgrade pip
                    pip install pip-audit

            -   name: Scan dependencies
                run: pip-audit -r requirements.txt --desc
                continue-on-error: true
